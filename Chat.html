<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
  /* Container do Chat ajustado para o Portal */
  #chat-container {
    display: flex;
    flex-direction: column;
    height: calc(95vh - 60px); 
    background-color: var(--bg-card);
    border: 1px solid var(--border-color);
    /* Se tiver a variável de sombra, use var(--shadow-color), senão mantenha o rgba */
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    
    border-radius: 12px;
    overflow: hidden;
  }

  /* Cabeçalho do Chat */
  .chat-header {
    padding: 15px 20px;
    background-color: var(--bg-card);
    border-bottom: 1px solid var(--border-color);
    
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .chat-header h3 { 
    margin: 0; 
    font-size: 1rem; 
    color: var(--text-primary); 
  }
  
  .status-dot { width: 8px; height: 8px; background: #28a745; border-radius: 50%; }

  /* Área das mensagens (Rolagem) */
  #chat-history {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    background-color: var(--bg-body);
  }

  /* Balões */
  .message {
    max-width: 80%;
    padding: 12px 16px;
    border-radius: 12px;
    line-height: 1.5;
    font-size: 0.95rem;
    position: relative;
    word-wrap: break-word;
  }

  .user-message {
    align-self: flex-end;
    background-color: var(--active-color); 
    color: #0b57d0; 
    
    border-bottom-right-radius: 2px;
  }

  .bot-message {
    align-self: flex-start;
    background-color: var(--bg-card);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    
    border-bottom-left-radius: 2px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }

  /* Formatação Markdown dentro do bot */
  .bot-message strong { 
    font-weight: 600; 
    color: var(--text-primary); 
  }
  .bot-message ul, .bot-message ol { padding-left: 20px; margin: 5px 0; }
  .bot-message p { margin: 5px 0; }

  /* Área de Input Fixa no final */
  .input-area {
    padding: 20px;
    background: var(--bg-card);
    border-top: 1px solid var(--border-color);
    
    display: flex;
    gap: 10px;
  }

  input[type="text"] {
    flex: 1;
    padding: 12px 15px;
    border: 1px solid var(--border-color);
    background: var(--input-bg);
    color: var(--text-primary);
    
    border-radius: 24px;
    font-size: 0.95rem;
    outline: none;
    transition: border 0.3s;
  }

  input[type="text"]:focus { border-color: #0b57d0; }

  button.send-btn {
    background-color: #0b57d0;
    color: white;
    border: none;
    padding: 0 24px;
    border-radius: 24px;
    cursor: pointer;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  }

  button.send-btn:hover { background-color: #0842a0; }
  button.send-btn:disabled { background-color: #ccc; cursor: not-allowed; }

  /* Animação de Carregando */
  .typing {
    display: none;
    align-self: flex-start;
    
    /* MUDANÇA: Fundo e Borda */
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    
    padding: 10px 15px;
    border-radius: 12px;
    margin-bottom: 10px;
  }
  .dot {
    height: 6px; width: 6px; background-color: #bbb;
    border-radius: 50%; display: inline-block;
    margin: 0 2px; animation: blink 1.4s infinite both;
  }
  .dot:nth-child(2) { animation-delay: 0.2s; }
  .dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }

</style>

<div id="chat-container">
  
  <div class="chat-header">
    <div class="status-dot"></div>
    <h3>Agente Especialista - Suporte Infra CDs</h3>
  </div>

  <div id="chat-history"></div>

  <div class="typing" id="loading-indicator">
    <span class="dot"></span><span class="dot"></span><span class="dot"></span>
  </div>

  <div class="input-area">
    <input type="text" id="user-input" placeholder="Digite sua dúvida..." onkeypress="handleEnter(event)">
    <button class="send-btn" id="btn-enviar" onclick="enviarPergunta()">
      <span class="material-icons" style="font-size:18px">send</span>
    </button>
  </div>

</div>

<script>
  // --- FUNÇÃO DE INICIALIZAÇÃO COM TRATAMENTO DE NOME ---
  (function initChat() {
    google.script.run.withSuccessHandler(function(email) {
      
      let nomeExibicao = "Visitante";

      if (email) {
        let parteLocal = email.split('@')[0];
        
        let primeiroNome = parteLocal.split('.')[0];
        
        if (primeiroNome.length > 0) {
          nomeExibicao = primeiroNome.charAt(0).toUpperCase() + primeiroNome.slice(1);
        }
      }
      
      // Cria a mensagem de boas-vindas
      const textoBoasVindas = `Olá, **${nomeExibicao}**! Como posso ajudá-lo hoje?`;
      
      // Formata e adiciona ao chat
      const htmlFormatado = marked.parse(textoBoasVindas);
      adicionarMensagem(htmlFormatado, 'bot');
      
    }).getEmailUsuario();
  })();

  // --- RESTANTE DAS FUNÇÕES (Sem alterações) ---

  function enviarPergunta() {
    const input = document.getElementById('user-input');
    const btn = document.getElementById('btn-enviar');
    const texto = input.value.trim();

    if (!texto) return;

    // 1. Mostra pergunta do usuário
    adicionarMensagem(texto, 'user');
    
    // 2. Trava interface
    input.value = '';
    input.disabled = true;
    btn.disabled = true;
    document.getElementById('loading-indicator').style.display = 'block';
    rolarParaFim();

    // 3. Chama o Google Apps Script
    google.script.run
      .withSuccessHandler(function(resposta) {
        esconderLoading();
        const htmlFormatado = marked.parse(resposta); 
        adicionarMensagem(htmlFormatado, 'bot');
        destravarInterface();
      })
      .withFailureHandler(function(erro) {
        esconderLoading();
        adicionarMensagem("Ocorreu um erro: " + erro.message, 'bot');
        destravarInterface();
      })
      .perguntarAoGemini(texto);
  }

  function adicionarMensagem(conteudo, tipo) {
    const historico = document.getElementById('chat-history');
    const div = document.createElement('div');
    div.classList.add('message');
    div.classList.add(tipo === 'user' ? 'user-message' : 'bot-message');
    
    if (tipo === 'bot') {
      div.innerHTML = conteudo; 
    } else {
      div.textContent = conteudo; 
    }

    historico.appendChild(div);
    rolarParaFim();
  }

  function rolarParaFim() {
    const historico = document.getElementById('chat-history');
    setTimeout(() => {
      historico.scrollTop = historico.scrollHeight;
    }, 50);
  }

  function esconderLoading() {
    document.getElementById('loading-indicator').style.display = 'none';
  }

  function destravarInterface() {
    const input = document.getElementById('user-input');
    const btn = document.getElementById('btn-enviar');
    input.disabled = false;
    btn.disabled = false;
    input.focus();
  }

  function handleEnter(e) {
    if (e.key === 'Enter') enviarPergunta();
  }
</script>